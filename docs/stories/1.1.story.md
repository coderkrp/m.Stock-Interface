# <!-- Powered by BMAD™ Core -->
# Story 1.1: Establish a Testing Framework

## Status
Ready for Review

## Story
**As a** developer,
**I want** to set up a `pytest` testing framework and add initial tests for the existing API endpoints,
**so that** I can safely refactor the code and add new features without introducing regressions.

## Acceptance Criteria
1. `pytest` is added to `requirements.txt`.
2. A `tests` directory is created with basic tests for the main API endpoints.
3. The tests pass successfully.

## Tasks / Subtasks
- [x] Task 1 (AC: 1): Add `pytest` to `requirements.txt`.
- [x] Task 2 (AC: 2): Create the `tests` directory at the project root. [Source: architecture/source-tree-integration.md]
- [x] Task 3 (AC: 2): Create a test file for `interface.py` (e.g., `tests/test_interface.py`). [Source: architecture/testing-strategy.md]
- [x] Task 4 (AC: 2): Write initial tests for the existing API endpoints in `interface.py`.
- [x] Task 5 (AC: 3): Run the tests using `python -m pytest` to ensure they pass. [Source: architecture/testing-strategy.md]

## Dev Notes
### Previous Story Insights
No previous story.

### Data Models
No specific guidance found in architecture docs.

### API Specifications
No specific guidance found in architecture docs.

### Component Specifications
No specific guidance found in architecture docs.

### File Locations
- Create a `tests` directory at the project root. [Source: architecture/source-tree-integration.md]

### Testing
- `pytest` is the designated testing framework. [Source: architecture/tech-stack-alignment.md]
- Tests should be organized in the `tests` directory. [Source: architecture/source-tree-integration.md]
- Run tests using `python -m pytest`. [Source: architecture/testing-strategy.md]
- Code should be formatted with Black and linted with flake8. [Source: architecture/coding-standards-and-conventions.md]

### Technical Constraints
- Use Python 3.11. [Source: architecture/tech-stack-alignment.md]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-02 | 1.0 | Initial draft | Bob (Scrum Master) |
| 2025-09-02 | 1.1 | Implemented testing framework and initial tests. | James (Dev Agent) |
| 2025-09-02 | 1.2 | Applied QA fixes: refactored logging, fixed `get_trades` endpoint, updated tests with mocking and dependency overrides. | James (Dev Agent) |

## Dev Agent Record
### Agent Model Used
Gemini

### Debug Log References
- `pip install -r requirements.txt` (for installing dependencies)
- `python -m pytest` (for running tests)
- `pip install ruff` (for installing linter)
- `python -m ruff check .` (for running linter)
- `pytest` (for running tests with fixture)

### Completion Notes List
- Added `pytest` and `slowapi` to `requirements.txt`.
- Created `tests` directory.
- Created `tests/test_interface.py` with a basic test for `/healthz` endpoint.
- Installed `pytest` and `ruff` in the virtual environment.
- Fixed linting errors in `interface.py` (import order, unused import, undefined exception).
- Fixed linting error in `tests/test_interface.py` (assert comparison).
- Refactored `interface.py` to replace `print` statements with `logger.info` and removed duplicate `mconnect.get_ltp` call.
- Modified `interface.py` to accept `fromDate` and `toDate` as query parameters for `/trades` endpoint.
- Updated `tests/test_interface.py` to use `client_with_mock_admin_token` fixture for mocking and dependency injection.
- Updated `tests/test_interface.py` to use `time.time()` for `interface.TOKENS.token_set_at`.
- Updated `tests/test_interface.py` to use full ISO 8601 format with microseconds and timezone for `fromDate` and `toDate` in `test_get_trades` and `test_get_historical_chart`.
- All tests are now passing.

### File List
- `requirements.txt`
- `tests/test_interface.py`
- `tests/conftest.py`
- `interface.py` (modified for linting fixes, `print` to `logger.info`, `get_trades` endpoint change, `get_ltp` response handling)

## QA Results

### Review Date: 2025-09-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Overall, the code quality is good, adhering to modern Python practices with FastAPI and Pydantic. The logging setup is well-structured. However, there are some areas for improvement:
- Broad exception handling (`except Exception as e:`) could be more specific.
- The default `APP_ADMIN_TOKEN` value of "change-me" is a security concern if not changed in production.

### Refactoring Performed

- **File**: `interface.py`
  - **Change**: Removed commented-out `mconnect.set_access_token(access_token)` line.
  - **Why**: To remove dead code and clarify the token handling flow.
  - **How**: Ensures the code is cleaner and more maintainable.
- **File**: `interface.py`
  - **Change**: Replaced `print` statements with `logger.info` in `auth_session` and `get_ltp`.
  - **Why**: To use the established logging framework for better observability and consistency.
  - **How**: Improves debugging and monitoring capabilities.
- **File**: `interface.py`
  - **Change**: Removed duplicate hardcoded `mconnect.get_ltp` call in `get_ltp`.
  - **Why**: To eliminate redundant code and potential for inconsistent behavior.
  - **How**: Makes the code more efficient and easier to maintain.

### Compliance Check

- Coding Standards: ✓ (After refactoring, linting passed)
- Project Structure: ✓
- Testing Strategy: ✗ (Limited test coverage for main API endpoints)
- All ACs Met: ✗ (AC2 partially met, AC3 passes for existing tests but overall coverage is low)

### Improvements Checklist

- [ ] Add more specific exception handling in `interface.py`.
- [ ] Address `DeprecationWarning` for `@app.on_event("startup")` by using `lifespan` event handlers.
- [ ] Address `DeprecationWarning` for `datetime.datetime.utcnow()` by using `datetime.datetime.now(datetime.UTC)`.
- [ ] Implement comprehensive tests for all main API endpoints in `interface.py` (e.g., `/auth/login`, `/auth/session`, `/orders`).
- [ ] Consider adding unit tests for `TokenCache` methods and `JsonFormatter`.
- [ ] Ensure `APP_ADMIN_TOKEN` is securely managed in production environments.

### Security Review

The default `APP_ADMIN_TOKEN` value of "change-me" is a security concern. While it's an environment variable, it should be strongly emphasized that this *must* be changed for any deployment beyond local development. Broad exception handling could potentially mask security-related errors, making them harder to detect.

### Performance Considerations

No specific performance issues identified, but broad exception handling could obscure performance bottlenecks.

### Files Modified During Review

- `interface.py`

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.1-establish-a-testing-framework.yml
Risk profile: docs/qa/assessments/1.1-risk-20250902.md
NFR assessment: docs/qa/assessments/1.1-nfr-20250902.md

### Recommended Status

✗ Changes Required - See unchecked items above

